# 서비스 관리

## 개요

**서비스 관리** 화면은 TACHYON 솔루션과 관련된 모든 systemd 서비스를 한눈에 확인하고, 시작/중지/재시작 등의 제어를 수행할 수 있는 기능입니다. 백그라운드에서는 **Watchdog 엔진**이 30초 주기로 서비스 상태를 감시하며, 장애 발생 시 의존성 순서에 따라 자동 복구를 시도합니다.

<!-- 스크린샷: 서비스 관리 전체 화면 -->
![서비스 관리 화면](../../assets/images/user/04_service_manager_overview.png)

---

## 서비스 목록 표시

### 자동 탐색 대상

tkadmin은 다음 서비스들을 자동으로 탐색하여 목록에 표시합니다:

**미들웨어 서비스 (Infrastructure)**

| 서비스명 | 역할 |
|----------|------|
| `mariadb` | 관계형 데이터베이스 |
| `redis` | 인메모리 캐시/세션 저장소 |
| `zookeeper` | 분산 코디네이션 |
| `kafka` | 메시지 브로커 |
| `opensearch` | 검색/로그 엔진 |
| `logstash-kafka-os` | 로그 파이프라인 |
| `nginx` | 웹 서버/리버스 프록시 |
| `opensearch-dashboards` | 로그 시각화 대시보드 |

**애플리케이션 서비스 (TACHYON)**

- `TACHYON-Auth1`, `TACHYON-Api1` 등 `/usr/lib/systemd/system/` 및 `/etc/systemd/system/` 경로에서 `TACHYON*.service` 패턴으로 자동 탐색

**관리 서비스**

- `tkadmin` (본 도구 자체 서비스)

### 상태 표시

각 서비스의 상태는 다음과 같이 시각적으로 구분됩니다:

| 상태 | 표시 색상 | 설명 |
|------|----------|------|
| **Active (Running)** | 초록색 | 서비스가 정상 실행 중 |
| **Exited (완료)** | 주황색 + `?` 힌트 | 초기 설정 등 1회성 작업을 마친 서비스 |
| **Inactive** | 회색 | 서비스가 중지된 상태 |
| **Failed** | 빨간색 + `?` 힌트 | 서비스 실행 실패 |

### 리소스 정보

각 서비스에 대해 다음 리소스 정보가 실시간으로 표시됩니다:

| 항목 | 설명 | 데이터 출처 |
|------|------|------------|
| **PID** | 프로세스 ID | `systemctl show -p MainPID` |
| **CPU%** | CPU 사용률 (코어 수 대비 정규화) | cgroup v2 직접 읽기 (`cpu.stat`) 또는 `ps` Fallback |
| **Memory** | 메모리 사용량 (사람이 읽기 쉬운 형식) | cgroup v2 직접 읽기 (`memory.current`) 또는 `ps` Fallback |

---

## 서비스 제어

### 제어 버튼

서비스 관리 화면에서 다음 세 가지 제어 버튼을 사용할 수 있습니다:

<!-- 스크린샷: 서비스 제어 버튼 (시작/중지/재시작) -->
![서비스 제어 버튼](../../assets/images/user/04_service_manager_controls.png)

| 버튼 | 색상 | 동작 | systemctl 명령 |
|------|------|------|---------------|
| **시작** | 초록색 | 중지된 서비스를 시작 | `systemctl start <서비스명>` |
| **중지** | 빨간색 | 실행 중인 서비스를 중지 | `systemctl stop <서비스명>` |
| **재시작** | 파란색 (Primary) | 서비스를 재시작 | `systemctl restart <서비스명>` |

### 서비스 제어 순서

1. 제어할 서비스를 확인합니다.
2. 원하는 제어 버튼(**시작**, **중지**, **재시작**)을 클릭합니다.
3. 확인 팝업이 표시됩니다: `서비스를 [동작] 하시겠습니까?`
4. **확인**을 클릭하면 서버에 제어 명령이 전송됩니다.
5. 실행 결과 메시지가 표시됩니다.

---

## Watchdog 자동 복구

### 동작 원리

Watchdog 엔진은 tkadmin이 실행되는 동안 백그라운드에서 지속적으로 동작합니다:

1. **30초** 주기로 모든 TACHYON 관련 서비스의 상태를 점검합니다.
2. 서비스가 중단(`inactive`) 또는 실패(`failed`) 상태로 감지되면:
   - `FAILURE` 알림을 생성합니다.
   - 해당 서비스에 대해 **자동 재시작**을 시도합니다.
3. 재시작 후 **5초** 대기 후 상태를 재확인합니다.
   - 정상화 시: `RECOVERY_SUCCESS` 알림 생성
   - 여전히 비정상 시: `RECOVERY_FAILED` 알림 생성

### 의존성 기반 복구 순서

Watchdog은 서비스 간 의존성을 고려하여 **우선순위 순서**대로 복구를 시도합니다. 인프라 서비스가 먼저 복구되어야 애플리케이션 서비스가 정상 동작할 수 있기 때문입니다:

| 우선순위 | 서비스 | 역할 |
|----------|--------|------|
| 1 | `mariadb` | 데이터베이스 |
| 2 | `redis` | 캐시/세션 |
| 3 | `zookeeper` | 분산 코디네이션 |
| 4 | `kafka` | 메시지 브로커 |
| 5 | `opensearch` | 검색 엔진 |
| 6 | `logstash-kafka-os` | 로그 파이프라인 |
| 7 | `nginx` | 웹 서버 |
| 8 | `opensearch-dashboards` | 시각화 |
| 9+ | `TACHYON-Auth1`, `TACHYON-Api1` ... | TACHYON 앱 서비스 |

?> **팁**: 인프라 서비스(우선순위 1~8)가 복구된 후에는 **10초간 안정화 대기**를 거친 뒤 다음 서비스의 상태를 점검합니다. 이를 통해 인프라가 완전히 기동된 상태에서 상위 애플리케이션이 복구되도록 보장합니다.

### 복구 결과 알림

Watchdog의 감지 및 복구 결과는 다음 방식으로 관리자에게 통보됩니다:

- **상단 빨간 배너**: Active 상태의 FAILURE 알림 시 표시
- **알림 뱃지**: 헤더 영역의 종 아이콘에 미읽음 건수 표시
- **관리자 보고**: 모든 이벤트가 [관리자 보고](07-report-viewer.md) 화면에 기록

---

## Watchdog 오탐 방지

### 의도적 서비스 제어와 Watchdog 간의 충돌 방지

운영자가 웹 UI 또는 `tkcli`를 통해 의도적으로 서비스를 중지했을 때, Watchdog이 이를 장애로 오인하여 자동 재시작하는 것을 방지하는 메커니즘이 내장되어 있습니다.

#### 동작 방식

1. **웹 UI에서 서비스 제어 시**:
   - `ControlService` API 호출 후 `RecordIntentionalAction`이 자동 실행됩니다.
   - Watchdog이 해당 서비스의 중단을 감지하더라도, 의도적 조치로 기록되어 있으므로 알림 및 자동 재시작을 **억제**합니다.

2. **tkcli에서 서비스 제어 시**:
   - tkcli는 먼저 `pending` 상태를 보고하여 의도적 조치를 **선등록**합니다.
   - 이후 실제 서비스 제어를 수행하고, 완료 결과를 보고합니다.
   - Watchdog은 pending 등록을 확인하고 알림을 억제합니다.

3. **의도적 플래그 만료**:
   - 등록된 의도적 조치 플래그는 **2분** 후 자동 만료됩니다.
   - 만료 후에도 서비스가 중단 상태이면 Watchdog이 정상적으로 장애 알림 및 복구를 수행합니다.

### 자동 업데이트/재시작 시 Grace Period (Lazy Loading)

서비스가 자체적으로 설정 적용이나 업데이트를 위해 짧은 시간 동안 재시작될 수 있습니다. 이 경우 운영자의 명시적 조치 없이도 서비스가 잠시 중단되는데, Watchdog이 이를 장애로 오인하지 않도록 **Grace Period(유예 시간) 메커니즘**이 적용됩니다.

#### 전환 상태 자동 감지

Watchdog은 systemd의 **SubState** 값을 분석하여 서비스가 자체 전환 중인지 판별합니다:

| SubState | 의미 | Grace Period |
|----------|------|:---:|
| `auto-restart` | systemd가 자동 재시작 중 | **15초** |
| `start` | 서비스 시작 진행 중 | **15초** |
| `stop` | 서비스 종료 진행 중 (재시작 전 단계) | **15초** |
| `activating` | 서비스 활성화 전환 중 | **15초** |
| `deactivating` | 서비스 비활성화 전환 중 | **15초** |
| `reloading` | 설정 리로드 중 | **15초** |
| `dead` | 서비스가 완전히 종료됨 | **5초** |
| `failed` | 서비스 실행 실패 | **5초** |

#### 동작 흐름

1. Watchdog이 서비스 중단을 감지합니다.
2. SubState가 전환 상태(`auto-restart`, `start` 등)이면 → **15초** 유예 시간을 부여합니다.
3. SubState가 `dead`/`failed`이면 → 축소된 **5초** 유예 시간을 부여합니다.
4. 유예 시간 후 서비스 상태를 **재확인**합니다:
   - ✅ 복구됨 → 알림 없이 정상 통과 (Info 레벨 로그만 기록)
   - ❌ 여전히 비정상 → 기존 장애 처리 흐름 진입 (FAILURE 알림 + 자동 복구 시도)

?> **팁**: Grace Period 덕분에 서비스가 자체 업데이트로 인해 잠시(수 초간) 중단되더라도 불필요한 장애 알림이 발생하지 않습니다. 이는 운영자의 알림 피로도(Alert Fatigue)를 줄여줍니다.

---

## 주의사항

!> **주의**: `tkadmin` 자체 서비스를 중지하면 웹 인터페이스에 접속할 수 없게 됩니다. 자체 서비스 재시작 시에는 약 1~2초간 접속이 중단될 수 있습니다.

!> **주의**: 인프라 서비스(MariaDB, Redis 등)를 중지하면, 이에 의존하는 TACHYON 애플리케이션 서비스도 함께 영향을 받을 수 있습니다. 인프라 서비스 중지 전 영향 범위를 반드시 확인하세요.

?> **팁**: 서비스를 의도적으로 중지한 경우, 2분 이내에 다시 시작하면 Watchdog의 불필요한 알림을 피할 수 있습니다. 장시간 중지가 필요한 경우, 2분 후 Watchdog이 자동 재시작을 시도할 수 있으므로 유의하세요.

---

## 관련 API

| API | 메서드 | 설명 |
|-----|--------|------|
| `/tkadmin/api/service/:action` | POST | 서비스 제어 (start, stop, restart) |
| `/tkadmin/api/service/resources` | GET | 서비스별 리소스(CPU, 메모리, PID) 조회 |
| `/tkadmin/api/monitor/report` | POST | tkcli 외부 보고 수신 |

---

## 다음 단계

- [환경 체크](05-env-check.md)에서 OS 설정 및 방화벽 상태를 점검하세요.
- [관리자 보고](07-report-viewer.md)에서 Watchdog 장애/복구 이력을 확인할 수 있습니다.

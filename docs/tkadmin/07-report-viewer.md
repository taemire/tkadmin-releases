# 관리자 보고

## 개요

**관리자 보고** 화면은 Watchdog 엔진의 자동 장애 감지 이벤트와 `tkcli` 외부 CLI 도구를 통한 수동 작업 보고를 **단일 테이블에 통합 표시**하는 기능입니다. 운영자는 이 화면을 통해 서비스의 장애 발생, 자동 복구, 수동 제어 등 모든 운영 이벤트를 시간순으로 파악하고, 읽음/미읽음 상태를 관리할 수 있습니다.

<!-- 스크린샷: 관리자 보고 전체 화면 -->
![관리자 보고 화면](assets/images/user/07_report_viewer_overview.png)

---

## 화면 구성

| 영역 | 설명 |
|------|------|
| **상단 툴바** | 유형 필터, 검색어 입력, 검색/모두 읽음 버튼, 데이터 소스 선택 |
| **보고 테이블** | 시간, 유형, 서비스, 메시지, 읽음 상태 컬럼 |

### 테이블 컬럼

| 컬럼 | 설명 | 기본 너비 |
|------|------|----------|
| **시간** | 이벤트 발생 시각 (한국어 날짜/시간 형식) | 220px |
| **유형** | 이벤트 유형 뱃지 | 120px |
| **서비스** | 대상 서비스명 | 150px |
| **메시지** | 이벤트 상세 내용 | 400px |
| **상태** | 읽음 여부 표시 | 80px |

---

## 보고 유형

관리자 보고에 기록되는 이벤트 유형은 다음과 같습니다:

| 유형 | 뱃지 색상 | 발생 조건 | 예시 메시지 |
|------|----------|----------|------------|
| **FAILURE** | 빨간색 (ERROR) | Watchdog이 서비스 중단/실패 감지 | `장애 감지: 서비스 'redis'가 중단된 상태입니다.` |
| **RECOVERY_SUCCESS** | 파란색 (INFO) | Watchdog 자동 재시작 성공 또는 tkcli 작업 성공 | `복구 성공: 'redis' 서비스가 정상화되었습니다.` |
| **RECOVERY_FAILED** | 노란색 (WARN) | Watchdog 자동 재시작 실패 또는 tkcli 작업 실패 | `복구 실패: 'kafka' 재시작 후에도 비정상 상태입니다.` |
| **INFO** | 파란색 (INFO) | tkcli 외부 보고 (수동 작업 결과) | `[tkcli] 서비스 'nginx'에 대해 'restart' 명령이 수동 수행되었습니다.` |
| **CONFIG_UPDATE** | 파란색 (INFO) | 전문가 편집기를 통한 설정 파일 변경 | `사용자 [GUID]가 설정 파일 'application.yml'을(를) 수정했습니다.` |

---

## 필터링 기능

### 유형별 필터

상단 툴바의 드롭다운에서 원하는 이벤트 유형을 선택하면, 해당 유형의 보고만 필터링합니다.

| 옵션 | 설명 |
|------|------|
| **모든 유형** | 필터 없이 전체 보고 표시 (기본값) |
| **장애 감지** | `FAILURE` 유형만 표시 |
| **복구 성공** | `RECOVERY_SUCCESS` 유형만 표시 |
| **복구 실패** | `RECOVERY_FAILED` 유형만 표시 |

### 서비스명/메시지 검색

1. 상단 툴바의 **검색 입력 필드**에 검색어를 입력합니다.
2. **검색** 버튼을 클릭하거나 `Enter` 키를 누릅니다.
3. **서비스명** 또는 **메시지 내용**에서 검색어가 포함된 항목만 표시합니다.
4. 검색은 대소문자를 **구분하지 않습니다**.

### 데이터 소스 선택

상단 툴바 우측에서 데이터 소스를 전환할 수 있습니다:

| 소스 | API | 설명 |
|------|-----|------|
| **전체 감사 로그 (History DB)** | `/tkadmin/api/audit-logs` | SQLite에 영구 보관된 전체 이력 (기본값) |
| **실시간 알림 (Latest 100)** | `/tkadmin/api/alerts` | 메모리 캐시의 최근 100건 알림 |

---

## 읽음 관리

### 미확인 항목 시각적 강조

읽지 않은(미확인) 보고 항목은 다음과 같이 시각적으로 구분됩니다:

| 요소 | 미읽음 | 읽음 |
|------|--------|------|
| **행 배경색** | 연한 빨간색 배경 (`rgba(239, 68, 68, 0.03)`) | 투명 |
| **상태 아이콘** | 빨간색 ● (볼드) | 회색 체크마크 |

<!-- 스크린샷: 미읽음/읽음 상태 구분 -->
![읽음 상태 구분](assets/images/user/07_report_viewer_read_status.png)

### 개별 읽음 처리

1. 보고 테이블에서 특정 항목의 **행을 클릭**합니다.
2. **보고 상세 모달**이 표시됩니다.
   - 점검 시점
   - 대상 서비스
   - 이벤트 유형
   - 상세 내용
   - 조치 권고 사항
3. 모달이 표시되면 해당 항목은 자동으로 **읽음 처리**됩니다.
4. **닫기** 버튼으로 모달을 닫습니다.

<!-- 스크린샷: 보고 상세 모달 -->
![보고 상세 모달](assets/images/user/07_report_viewer_detail_modal.png)

### 일괄 읽음 처리

1. 상단 툴바의 **모두 읽음** 버튼을 클릭합니다.
2. 모든 미확인 보고 항목이 즉시 읽음 상태로 전환됩니다.
3. 헤더의 알림 뱃지와 사이드바 뱃지도 함께 업데이트됩니다.

---

## 실시간 갱신

관리자 보고 화면에 진입하면 **10초 주기**로 보고 데이터를 자동 폴링합니다:

| 항목 | 값 |
|------|-----|
| **폴링 주기** | 10초 |
| **동작** | 선택된 데이터 소스에서 최신 데이터를 조회하여 테이블 갱신 |
| **종료 조건** | 다른 메뉴로 이동하면 타이머 자동 해제 |

---

## 알림 배너 정책

### 상단 빨간 배너

- **Active FAILURE만 표시**: 현재 장애가 발생했으나 아직 복구되지 않은(동일 서비스에 대한 `RECOVERY_SUCCESS`가 없는) 최신 `FAILURE` 알림만 빨간색 상단 배너로 표시합니다.
- **복구 시 자동 숨김**: 장애가 발생한 서비스에 대해 `RECOVERY_SUCCESS` 알림이 수신되면, 해당 장애 배너는 즉시 숨김 처리됩니다.
- **클릭 동작**: 배너를 클릭하면 해당 장애의 상세 보고 모달이 열립니다.

### 알림 뱃지

- **헤더 영역**: 종 아이콘 옆에 미읽음 건수가 뱃지로 표시됩니다 (최대 `99+`).
- **사이드바**: 관리자 보고 메뉴 항목에 미읽음 건수가 뱃지로 표시됩니다 (최대 `9+`).
- **갱신 주기**: 10초 주기로 정확한 미읽음 건수를 DB에서 조회하여 업데이트합니다.

### 감사 추적성 준수

!> **주의**: 배너가 사라지더라도(복구 성공 시), 관리자가 직접 **읽음 처리**하기 전까지는 알림 뱃지 및 보고 목록의 미읽음 상태가 **절대 자동으로 해제되지 않습니다**. 이는 사후 장애 이력 확인을 보장하기 위한 **감사 추적성(Audit Integrity)** 원칙에 따른 설계입니다.

즉, 복구 성공으로 배너는 사라지지만:
- 헤더 알림 뱃지의 미읽음 건수는 유지됩니다.
- 관리자 보고 테이블에서 해당 항목은 미읽음 상태로 남아 있습니다.
- 관리자가 직접 항목을 열어 확인하거나, **모두 읽음** 버튼을 클릭해야만 읽음 처리됩니다.

---

## 알림 데이터 영속성

### SQLite 기반 영구 보관

모든 장애 및 복구 알림은 SQLite 데이터베이스(`audit_logs` 테이블)에 기록됩니다.

| 필드 | 설명 |
|------|------|
| `id` | 고유 식별자 (자동 증가) |
| `time` | 이벤트 발생 시각 |
| `service` | 대상 서비스명 |
| `type` | 이벤트 유형 (FAILURE, RECOVERY_SUCCESS 등) |
| `message` | 상세 메시지 |
| `is_healing` | Watchdog 자동 복구 중 여부 |
| `read` | 읽음 여부 (0/1) |

### 재시작 시 데이터 복원

tkadmin이 재시작되면 SQLite에서 최근 알림 내역(최대 100건)을 메모리로 로드하여 대시보드 상태를 복원합니다. 따라서 서비스 재시작 후에도 이전의 장애/복구 이력이 보존됩니다.

---

## 주의사항

!> **주의**: **모두 읽음** 버튼을 클릭하면 모든 미확인 보고가 일괄 읽음 처리됩니다. 중요한 장애 보고를 놓치지 않도록, 가급적 개별 항목을 확인한 후 읽음 처리하는 것을 권장합니다.

?> **팁**: 반복적인 `RECOVERY_FAILED` 알림이 발생하면, 해당 서비스의 로그를 [시스템 로그](06-log-viewer.md) 화면에서 확인하고, 근본 원인(MariaDB 연결 실패, 포트 충돌 등)을 해결해야 합니다.

?> **팁**: `tkcli`를 통한 원격 작업 이력도 이 화면에 통합 표시되므로, 여러 운영자가 수행한 작업의 이력을 한곳에서 추적할 수 있습니다.

---

## 관련 API

| API | 메서드 | 설명 |
|-----|--------|------|
| `/tkadmin/api/alerts` | GET | 메모리 캐시의 최근 알림 조회 (최대 100건) |
| `/tkadmin/api/audit-logs` | GET | SQLite 감사 로그 전체 조회 |
| `/tkadmin/api/alerts/:id` | GET | 특정 알림 상세 조회 |
| `/tkadmin/api/alerts/read` | POST | 모든 알림 일괄 읽음 처리 |
| `/tkadmin/api/alerts/unread` | GET | 미읽음 건수 조회 |
| `/tkadmin/api/monitor/report` | POST | tkcli 외부 보고 수신 |

### tkcli 보고 API 페이로드

```json
{
  "service": "서비스명",
  "action": "start|stop|restart",
  "status": "pending|success|fail",
  "source": "tkcli"
}
```

| 필드 | 설명 |
|------|------|
| `service` | 제어 대상 서비스명 |
| `action` | 수행한 동작 |
| `status` | `pending` (사전 등록), `success` (성공), `fail` (실패) |
| `source` | 보고 출처 (예: `tkcli`) |

---

## 다음 단계

- [서비스 관리](04-service-manager.md)에서 장애가 발생한 서비스를 직접 제어하세요.
- [시스템 로그](06-log-viewer.md)에서 서비스 오류의 근본 원인을 추적하세요.
- [전문가 편집기](03-advanced-editor.md)에서 설정 변경 이력을 확인하세요.
